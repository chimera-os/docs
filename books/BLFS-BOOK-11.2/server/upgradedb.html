<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content=
    "application/xhtml+xml; charset=iso-8859-1" />
    <title>
      Important notes about upgrading Database Server Software
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL-NS Stylesheets Vsnapshot" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="blfs" id="blfs-11.2">
    <div class="navheader">
      <h4>
        Beyond Linux<sup>®</sup> From Scratch <span class=
        "phrase">(systemd</span> Edition) - Version 11.2
      </h4>
      <h3>
        Chapter&nbsp;22.&nbsp;Databases
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="databases.html" title="Databases">Prev</a>
          <p>
            Databases
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="db.html" title="Berkeley DB-5.3.28">Next</a>
          <p>
            Berkeley DB-5.3.28
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="databases.html" title=
          "Chapter&nbsp;22.&nbsp;Databases">Up</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch  (systemd  Edition) - Version 11.2">Home</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="en" xml:lang="en">
      <h1 class="sect1">
        <a id="upgradedb" name="upgradedb"></a>Important notes about
        upgrading Database Server Software
      </h1>
      <div class="admon note">
        <img alt="[Note]" src="../images/note.png" />
        <h3>
          Note
        </h3>
        <p>
          This section is about reinstalling database software when an
          existing database is in use. It is not applicable for initial
          installations or if there is no existing database for the package
          being updated, but users should read through it to become aware of
          issues that can arise in the future.
        </p>
      </div>
      <p>
        Lets start this chapter with a dramatic screenshot of an issue that
        really happened. This issue will not occur if you are going to
        install the software the first time:
      </p>
      <pre class="screen">$ sudo systemctl status postgresql
-- postgresql.service - PostgreSQL database server
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since Tue 2021-10-26 17:11:53 CDT; 2min 49s ago
    Process: 17336 ExecStart=/usr/bin/pg_ctl -s -D ${PGROOT}/data start -w -t 120 (code=exited, status=1/FAILURE)
        CPU: 7ms

Oct 26 17:11:53 SVRNAME systemd[1]: Starting PostgreSQL database server...
Oct 26 17:11:53 SRVNAME postgres[17338]: 2021-10-26 17:11:53.420 CDT [17338] FATAL:
                database files are incompatible with server
Oct 26 17:11:53 SRVNAME postgres[17338]: 2021-10-26 17:11:53.420 CDT [17338] DETAIL:
                The data directory was initialized by PostgreSQL version 13,
                which is not compatible with this version 14.0.
Oct 26 17:11:53 SRVNAME postgres[17336]: pg_ctl: could not start server
Oct 26 17:11:53 SRVNAME postgres[17336]: Examine the log output.
Oct 26 17:11:53 SRVNAME systemd[1]: postgresql.service: Control process exited, code=exited, status=1/FAILURE
Oct 26 17:11:53 SRVNAME systemd[1]: postgresql.service: Failed with result 'exit-code'.
Oct 26 17:11:53 SRVNAME systemd[1]: Failed to start PostgreSQL database server.</pre>
      <p>
        To avoid situations like the one above finding your database server
        software refusing to start, read the following thoughts about how to
        upgrade a DBMS (Database Management System) prior to actually doing
        the upgrade.
      </p>
      <p>
        The root cause of the issue shown above was an upgrade of the server
        software to a newer major version but leaving the data files
        untouched. The administrator was able to recover without any loss of
        data.
      </p>
      <p>
        Even if you are doing an install DBMS install, read through this
        section. Tt will provide you information about how to set up backup
        and restore procedures (at least the strategy for building them)
        which are sufficient for your needs and for the safety of your data.
      </p>
      <div class="sect2" lang="en" xml:lang="en">
        <h2 class="sect2">
          Upgrade database server packages
        </h2>
        <p>
          Database systems work on files which hold the database metadata and
          the data itself. Those files are highly optimized in their internal
          structures for use by the server software. When upgrading such
          server software, newer server software may expect a different file
          format than was created by previous versions. In the best case, the
          new software can act on the old format as well&mdash;but not
          benefitting from newer formats which might result in better
          performance or of other improvements. It can also happen that the
          new server software will reformat the data files automatically when
          starting.
        </p>
        <p>
          Unfortunately, the most likely case is that the new server software
          complains about out of date file formats and exits. When this
          happens and you have overwritten the installed server software, you
          may not be able to read the data files and the new software is
          unwilling to do so.
        </p>
        <p>
          Changes in data file formats usually happen at major version
          changes but potentially can come at other times. Before upgrading
          the server software, check the documentation if there are changes
          which will require reformatting the database.
        </p>
        <p>
          Of course, if you have databases with content which is not easy to
          rebuild, it is always a good idea to create backups of the database
          from time to time. When upgrading the server software, it is time
          to run another backup.
        </p>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369285968" name="idm140068369285968"></a>Upgrade
            by backup and restore
          </h4>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              A backup is meaningless if there is no verified process to
              restore the data from this backup. When running a database
              server, you should not only create backups but you should also
              verify that the process you designed to fulfill the restore
              task is working properly. When you encounter a problem with the
              restore when you urgently have to rely on the backup data, it
              is too late&mdash;your database is in danger.
            </p>
          </div>
          <p>
            In general, most (all?) database server software provides some
            basic tools to create backups of your data. Usually the backups
            created with those tools can be read by newer versions of the
            software (via a restore tool). Using older restore tools with
            newer backup data is not defined and you should <span class=
            "emphasis"><em>never</em></span> blindly assume that it will
            work. It might, but usually it doesn't.
          </p>
          <p>
            The easiest way to upgrade your database files is to
          </p>
          <div class="itemizedlist">
            <ul>
              <li class="listitem">
                <p>
                  Create a full database backup using the old tools.
                </p>
                <p>
                  This step creates an offline copy of the database files
                  ready to be used for long term archiving, for disaster
                  recovery, or just preparation for upgrade. This offline
                  backup consists of the full one-to-one copy of the current
                  database files or a backup of the files from a certain time
                  in history plus all journal data (that is Oracle®
                  terminology, it is called "Continuous Archiving" or "write
                  ahead log (WAL)" in Postgresql) containing information
                  about changes made to the data content. The later take less
                  time to create if the DB software provides this type of
                  journaling as you only have to save the changes after
                  creating the last backup. The amount of data to backup is
                  much less than doing a full backup every time.
                </p>
                <p>
                  In terms of upgrading database server software, a full
                  backup (which can be used for subsequent incremental
                  backups) should be made, but if the amount of data is too
                  big, an incremental backup will be sufficient. Which
                  strategy is appropriate for you depends on the amount of
                  data stored in your database (is it a few hundred table
                  rows or is it hundreds of terabytes?). A full backup of the
                  later one isn't done quickly (and we assume that the
                  underlying system of such a database is probably not on an
                  LFS system). To close the last gap to fully protect your
                  data, create a backup of the corresponding old binaries
                  (and/or their sources) and store it along with the data
                  files to make sure that there is a fallback solution if the
                  newer software is not able to read the older data.
                </p>
              </li>
              <li class="listitem">
                <p>
                  Upgrade the server software
                </p>
                <p>
                  In this step, instructions to build the database server
                  software are executed just as they are shown in subsequent
                  sections talking about the DBMs like MariaDB or Postgresql.
                  That is, build the software as usual using BLFS
                  instructions.
                </p>
              </li>
              <li class="listitem">
                <p>
                  Restore the database by using the new tools.
                </p>
                <p>
                  To restore the data, the tools of the newly installed
                  server software should be used. During the restoration
                  process, the new tools will create and/or upgrade the data
                  files in the format the software requires. It is assumed
                  that newer software is capable of reading old data.
                </p>
              </li>
            </ul>
          </div>
          <p>
            Since you have already have a backup procedure in place (and you
            have tested your restore procedure, right?), this might be the
            easiest way to upgrade as you are going to use your well known
            processes to upgrade just as you always do&mdash;at least in
            terms of the backup and restore.
          </p>
        </div>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369273568" name="idm140068369273568"></a>Upgrade
            the database files by using system tools
          </h4>
          <p>
            Some database systems (for instance Postgresql) provide a tool
            which can reformat (upgrade) the existing database files to the
            new format. Since the upgrading tool has to be used from the new
            server software (the old one cannot know anything about a new
            file format), the old software might be overwritten due to
            installation of the new software.
          </p>
          <p>
            In case you have to restore a backup (for example, running the
            upgrade tool failed) you have to reinstall the old version to get
            back the access to your data.
          </p>
          <p>
            Even though those tools might work with one of the actual
            database files, you should create a full backup before running
            them. A failure might result in a serious damage of the database
            files.
          </p>
        </div>
      </div>
      <div class="sect2" lang="en" xml:lang="en">
        <h2 class="sect2">
          Notes for specific DBMS
        </h2>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369270128" name=
            "idm140068369270128"></a>PostgreSQL
          </h4>
          <p>
            Upstream documentation for Backup/Restore: <a class="ulink" href=
            "https://www.postgresql.org/docs/current/backup.html">https://www.postgresql.org/docs/current/backup.html</a>
          </p>
        </div>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369267968" name="idm140068369267968"></a>MariaDB
          </h4>
          <p>
            Upstream documentation for Backup/Restore: <a class="ulink" href=
            "https://mariadb.com/kb/en/backup-and-restore-overview/">https://mariadb.com/kb/en/backup-and-restore-overview/</a>
          </p>
        </div>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369265808" name="idm140068369265808"></a>Sqlite
          </h4>
          <p>
            Do not underestimate <span class="application">Sqlite</span>. It
            is a feature rich DBMS. The main difference from the two big
            players above is that Sqlite does not provide access via a
            network API. Sqlite databases are files always stored on the same
            machine as the running program which uses the database. The
            manipulation of data content is done via API calls to library
            functions directly within the program.
          </p>
          <p>
            In the upstream documentation you may find the following useful:
          </p>
          <p>
            Documentation of the sqlite3 command line tool: <a class="ulink"
            href=
            "https://www.sqlite.org/cli.html">https://www.sqlite.org/cli.html</a>
          </p>
          <p>
            Documentation of backup API calls: <a class="ulink" href=
            "https://www.sqlite.org/backup.html">https://www.sqlite.org/backup.html</a>
          </p>
          <p>
            Unfortunately, there is no dedicated chapter in the upstream
            documentation talking about backup/restore but there are several
            articles about it on the Internet. One example is shown below.
          </p>
          <p>
            Documentation for Backup/Restore: <a class="ulink" href=
            "https://database.guide/backup-sqlite-database/">https://database.guide/backup-sqlite-database/</a>
          </p>
        </div>
        <div class="sect3" lang="en" xml:lang="en">
          <h3 class="sect3"></h3>
          <h4 class="title">
            <a id="idm140068369259472" name="idm140068369259472"></a>Berkeley
            DB
          </h4>
          <p>
            Just like <span class="application">Sqlite</span> this software
            acts on local database files meaning there is no network
            interface.
          </p>
          <p>
            The relevant resources for Backup/Restore a Berkeley database are
            the man pages for <code class="filename">db_dump</code> and its
            counterpart <code class="filename">db_load</code>.
          </p>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="databases.html" title="Databases">Prev</a>
          <p>
            Databases
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="db.html" title="Berkeley DB-5.3.28">Next</a>
          <p>
            Berkeley DB-5.3.28
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="databases.html" title=
          "Chapter&nbsp;22.&nbsp;Databases">Up</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch  (systemd  Edition) - Version 11.2">Home</a>
        </li>
      </ul>
    </div>
  </body>
</html>
